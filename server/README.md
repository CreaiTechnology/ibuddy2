# iBuddy Backend API

Backend server for the iBuddy platform integration API, using Supabase as the backend.

## Setup

1.  **Supabase Project:** Create a new project on [supabase.com](https://supabase.com).
2.  **Database Schema:**
    *   Go to the SQL Editor in your Supabase project.
    *   Create the `platforms` table. You can use the following SQL as a starting point (adjust types/constraints as needed):

        ```sql
        CREATE TABLE public.platforms (
          id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
          user_id uuid NOT NULL, -- References auth.users(id) if using Supabase Auth
          platform_type text NOT NULL,
          account_id text NOT NULL,
          account_name text NOT NULL,
          access_token text NOT NULL,
          refresh_token text NULL,
          token_expires_at timestamptz NULL,
          metadata jsonb NULL DEFAULT '{}'::jsonb,
          is_active boolean NULL DEFAULT true,
          connected_at timestamptz NULL DEFAULT now(),
          last_updated_at timestamptz NULL DEFAULT now(),
          created_at timestamptz NULL DEFAULT now(),
          CONSTRAINT platforms_user_id_platform_type_key UNIQUE (user_id, platform_type)
          -- Optional: Add foreign key constraint if using Supabase Auth
          -- CONSTRAINT platforms_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE
        );

        -- Optional: Enable Row Level Security (Recommended)
        ALTER TABLE public.platforms ENABLE ROW LEVEL SECURITY;

        -- Optional: Create policies (Example: Allow users to manage their own platforms)
        CREATE POLICY "Allow individual user access" ON public.platforms
          FOR ALL
          USING (auth.uid() = user_id);
        ```
    *   Note: If you are not using Supabase Auth, replace `user_id uuid NOT NULL` with your custom user ID type and remove the foreign key constraint.

3.  **Install Dependencies:**
    ```bash
    cd server
    npm install
    ```

4.  **Configure Environment Variables:**
    *   Copy `server/.env.example` to `server/.env`.
    *   Update the values in `server/.env`:
        *   `SUPABASE_URL`: Find this in your Supabase project settings (API -> Project URL).
        *   `SUPABASE_ANON_KEY`: Find this in your Supabase project settings (API -> Project API keys -> anon public).
        *   Update platform-specific API keys (`WHATSAPP_CLIENT_ID`, `FACEBOOK_APP_ID`, etc.).
        *   `JWT_SECRET` if you are managing your own JWTs.

5.  **Start the Development Server:**
    ```bash
    npm run dev
    ```

## API Documentation

### Platform Authentication

The API supports multiple platform integrations using OAuth 2.0 flows. The backend stores connection details in a Supabase PostgreSQL database.

Currently supported platforms include:

- WhatsApp
- Messenger
- Shopee
- Lazada
- Telegram
- Gmail
- Facebook
- Instagram
- Xiaohongshu

### Endpoints

#### Get Platform Status

```
GET /api/platforms/status
```

Returns the connection status of all platforms for the current user.

Response:
```json
{
  "whatsapp": false,
  "messenger": false,
  "shopee": false,
  "lazada": false,
  "telegram": false,
  "gmail": false,
  "facebook": true,
  "instagram": false,
  "xiaohongshu": false
}
```

#### Authorize Platform

```
POST /api/platforms/:platform/authorize
```

Initiates the platform authorization process. In a real implementation, this would redirect to the platform's authorization page.

Parameters:
- `platform`: The platform identifier (e.g., `facebook`, `whatsapp`)

For testing, you can provide an authorization code in the request body:
```json
{
  "code": "mock-auth-code"
}
```

Response:
```json
{
  "success": true,
  "platform": "facebook",
  "accountInfo": {
    "id": "facebook-page-1234567890",
    "name": "Business Demo Page",
    "connectedAt": "2023-01-01T00:00:00.000Z",
    "platformType": "facebook"
  }
}
```

#### Platform Authorization Callback

```
GET /api/platforms/:platform/callback
```

Handles the callback from the platform's OAuth flow.

Parameters:
- `platform`: The platform identifier (e.g., `facebook`, `whatsapp`)
- `code`: The authorization code (query parameter)

Response:
```json
{
  "success": true,
  "platform": "facebook",
  "accountInfo": {
    "id": "facebook-page-1234567890",
    "name": "Business Demo Page",
    "connectedAt": "2023-01-01T00:00:00.000Z",
    "platformType": "facebook"
  }
}
```

#### Unbind Platform

```
POST /api/platforms/:platform/unbind
```

Disconnects a platform integration for the current user.

Parameters:
- `platform`: The platform identifier (e.g., `facebook`, `whatsapp`)

Response:
```json
{
  "success": true,
  "platform": "facebook"
}
```

#### Get Platform Account Info

```
GET /api/platforms/:platform/account
```

Gets account information for a connected platform.

Parameters:
- `platform`: The platform identifier (e.g., `facebook`, `whatsapp`)

Response:
```json
{
  "id": "facebook-page-1234567890",
  "name": "Business Demo Page",
  "connectedAt": "2023-01-01T00:00:00.000Z",
  "platformType": "facebook"
}
```

## Development

-   For development, set `BYPASS_AUTH=true` in your `server/.env` file to bypass JWT authentication middleware requirements. A mock user ID (`MOCK_USER_ID`) will be used.
-   If Supabase URL/Key are missing in `.env`, the service layer will log warnings and return mock responses instead of throwing errors (useful for frontend development without a full Supabase setup). In production, missing Supabase keys will prevent the server from starting correctly. 